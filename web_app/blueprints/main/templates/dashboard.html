{% extends 'main/base.html' %}
{% block content %}

<div class="flex min-h-[88vh] flex-col justify-top px-6 py-12 lg:px-8" x-data="dashboardData">

    <template x-if="!loaded">
        <div class="flex items-center justify-center">
            <div class="px-3 py-1 text-lg font-medium leading-none text-center text-blue-800 bg-blue-200 rounded-full animate-pulse dark:bg-blue-900 dark:text-blue-200">loading...</div>
        </div>
    </template>

    <template x-if="loaded">
        <div>
            <template x-if="events.length === 0">
                <div class="w-75 mx-auto text-center">
        
                    <h1 class="mb-4 text-4xl font-extrabold leading-none tracking-tight text-gray-900 md:text-5xl lg:text-6xl dark:text-white">Welcome to your dashboard!</h1>
                    <p class="mb-6 text-lg font-normal text-gray-500 lg:text-xl sm:px-16 xl:px-48 dark:text-gray-400">Your events will appear here. Create a new event or sign up for an existing one by clicking the corresponding button below.</p>
                    <button @click="showAddEventModal = true" class="inline-flex items-center justify-center px-5 py-3 text-base font-medium text-center text-white bg-blue-700 rounded-lg hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-900">
                        Create your first event
                        <svg class="w-3.5 h-3.5 ms-2 rtl:rotate-180" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 10">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 5h12m0 0L9 1m4 4L9 9"/>
                    </svg>
                    </button>
                
                </div>
            </template>
    
            <template x-if="events != []">
                <div>

                    <h1 class="text-2xl font-bold pb-4">Events you organize</h1>
                    <hr class="pb-4">
                    <div class="flex flex-row flex-wrap align-top grid-cols-4 gap-4">
                        <button @click="showAddEventModal = true" class="max-w-sm p-6 bg-gray-50 border-4 border-dashed rounded-lg hover:border-green-400 hover:bg-gray-100 dark:bg-gray-800 dark:border-gray-700 min-w-[40px]">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mx-auto">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                            </svg>
                            
                            <h5 class="mb-2 text-2xl font-bold tracking-tight text-gray-900 dark:text-white">Add new event</h5>
                        </button>
                        <template x-for="event in events.new">
                            <div class="max-w-sm p-6 bg-gray-100 border border-gray-200 rounded-lg shadow-md dark:bg-gray-800 dark:border-gray-700 min-w-[20%] text-center">
                                <h5 class="mb-2 text-2xl font-bold tracking-tight text-gray-900 dark:text-white" x-text="event.name"></h5>
                                <p class="mb-3 font-normal text-gray-700 dark:text-gray-400">
                                    <small class="font-bold">Author: </small>
                                    <small x-text="event.author.email"></small>
                                </p>
                                <a href="#" class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white bg-blue-700 rounded-lg hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                                    Click to sign up
                                    <svg class="rtl:rotate-180 w-3.5 h-3.5 ms-2" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 10">
                                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 5h12m0 0L9 1m4 4L9 9"/>
                                    </svg>
                                </a>
                            </div>
                        </template>         
                    </div>

                    <h1 class="text-2xl font-bold py-4">Events you sign-up for</h1>
                    <hr class="pb-4">
                    <div class="flex flex-row flex-wrap align-top grid-cols-4 gap-4">
                        <template x-for="event in events.atendee">
                            <div class="max-w-sm p-6 bg-gray-100 border border-gray-200 rounded-lg shadow-md dark:bg-gray-800 dark:border-gray-700 min-w-[20%] text-center">
                                <h5 class="mb-2 text-2xl font-bold tracking-tight text-gray-900 dark:text-white" x-text="event.name"></h5>
                                <p class="mb-3 font-normal text-gray-700 dark:text-gray-400">
                                    <small class="font-bold">Author: </small>
                                    <small x-text="event.author.email"></small>
                                </p>
                                <a href="#" class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white bg-blue-700 rounded-lg hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                                    Click to sign up
                                    <svg class="rtl:rotate-180 w-3.5 h-3.5 ms-2" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 10">
                                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 5h12m0 0L9 1m4 4L9 9"/>
                                    </svg>
                                </a>
                            </div>
                        </template>         
                    </div>

                    <h1 class="text-2xl font-bold py-4">Sign-up for event</h1>
                    <hr class="pb-4">
                    <div class="flex flex-row flex-wrap align-top grid-cols-4 gap-4">
                        <template x-for="event in events.frees">
                            <div class="max-w-sm p-6 bg-gray-100 border border-gray-200 rounded-lg shadow-md dark:bg-gray-800 dark:border-gray-700 min-w-[20%] text-center">
                                <h5 class="mb-2 text-2xl font-bold tracking-tight text-gray-900 dark:text-white" x-text="event.name"></h5>
                                <p class="mb-3 font-normal text-gray-700 dark:text-gray-400">
                                    <small class="font-bold">Author: </small>
                                    <small x-text="event.author.email"></small>
                                </p>
                                <a href="#" class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white bg-blue-700 rounded-lg hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                                    Click to sign up
                                    <svg class="rtl:rotate-180 w-3.5 h-3.5 ms-2" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 10">
                                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 5h12m0 0L9 1m4 4L9 9"/>
                                    </svg>
                                </a>
                            </div>
                        </template>         
                    </div>
                                           
                </div>       
            </template>
        </div>
    </template>

    {% from 'components/modals.jinja' import addEventModal %}
    {{ addEventModal() }}

</div>

<script>

    document.addEventListener('alpine:init', () => {
        Alpine.data('dashboardData', () => ({

            userId: `{{ session['user_id'] }}`,
            events: {},
            request: {},
            loaded: true,
            showAddEventModal: false, 

            init() {
                this.$nextTick(async () => { 
                    await this.getEvents() 
                    setTimeout(() => this.loaded = true, 3000)
                })
                this.$watch('loaded', () => { this.clearRequest() })
             },
            async getEvents() {
                const resp = await fetch('/events/all')
                const data = await resp.json()
                this.events.author = data.filter(event => event.author_id == this.userId)
                this.events.atendee = data.filter(event => event.atendee_list.map(ev => ev.user_id == this.userId))
                this.events.new = data.filter(event => event.atendee_list.map(ev => ev.user_id != this.userId))
            },
            async createEvent() {
                const resp = await fetch('/events/new', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.request)
                })
                const data = await resp.json()
                showAlert(resp, data)
            },
            async deleteEvent() {
                const swalWithTailwindButtons = Swal.mixin({
                    customClass: {
                        confirmButton: 'bg-green-500 text-white hover:bg-green-700 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 mr-2 mb-2 dark:bg-green-600 dark:hover:bg-green-700 focus:outline-none focus:ring-green-800',
                        cancelButton: 'bg-red-500 text-white hover:bg-red-700 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 mr-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 focus:outline-none focus:ring-red-800'
                    },
                    buttonsStyling: false
                });
            
                swalWithTailwindButtons.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, delete it!',
                    cancelButtonText: 'No, cancel!',
                    reverseButtons: true
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        const resp = await fetch(`/events/${this.userId}`, {method: 'DELETE'})
                        const data = await resp.json()
                        showAlert(resp, data)
                    }
                });
            },
            clearRequest() {
                this.request = {name: null, date_from: null, date_to: null, author_id: this.userId}
            },
            closeAddEventModal() {
                this.showAddEventModal = false
                this.clearRequest()
            },

        }))
    })


</script>

{% endblock content %}